<!DOCTYPE html>
<html>
<head>
  <title>Chance's Party - Admin</title>
  <link rel="stylesheet" href="/css/main.css" />
</head>
<body>
  <content></content>
  <script type="text/javascript" async src="https://unpkg.com/whatwg-fetch@2.0.3"></script>
  <script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function domContentLoaded() {
      let startPartyLink = document.querySelector('#startParty');
      if (startPartyLink) {
        startPartyLink.addEventListener('click', function (e) {
          let playlistId = e.target.getAttribute('data-id');
          let hostName = e.target.getAttribute('data-host');
          let headers = new Headers();
          headers.append('Content-Type', 'application/json; charset=utf-8');
          let startParty = window.fetch(new Request('/party/start', {
            method: 'POST',
            headers: headers,
            body: JSON.stringify({
              data: {
                host: decodeURIComponent(hostName),
                playlist_id: decodeURIComponent(playlistId)
              }
            }),
            credentials: 'include',
            cache: 'no-store'
          })).then(function (response) {
            return response.json();
          }).then(function (newPartyOrErrors) {
            if (newPartyOrErrors.errors !== undefined) {
              console.log(newPartyOrErrors);
              throw new Error(newPartyOrErrors.errors);
            }

            return newPartyOrErrors.data;
          });

          startParty.then(function (party) {
            console.log('Started party:', party)
          });
        })
      }

      let playlistLinks = [].slice.call(document.querySelectorAll('a.playlist'));
      playlistLinks.forEach(function (playlistLink) {
        playlistLink.addEventListener('click', function (e) {
          let playlistId = e.target.getAttribute('data-id');
          let headers = new Headers();
          headers.append('Content-Type', 'application/json; charset=utf-8');
          let patchPlaylist = window.fetch(new Request('/playlist', {
            method: 'PATCH',
            headers: headers,
            body: JSON.stringify({
              data: { id: decodeURIComponent(playlistId) }
            }),
            credentials: 'include',
            cache: 'no-store'
          })).then(function (response) {
            return response.json();
          }).then(function (patchedPlaylistOrErrors) {
            if (patchedPlaylistOrErrors.errors !== undefined) {
              console.log(patchedPlaylistOrErrors);
              throw new Error(patchedPlaylistOrErrors.errors);
            }

            return patchedPlaylistOrErrors.data;
          });

          patchPlaylist.then(function (playlist) {
            document.querySelector('#currentPlaylist').innerText =
              playlist.name;
          });
        })
      })
    })
  </script>
</body>
</html>
